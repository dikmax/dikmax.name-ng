---
title: "Проблемы с запуском планировщика"
date: "2014-03-30T19:00:00+03:00"
published: true
tags: "angulardart, dart, dart2js, блог, планировщик маршрута, программирование"
thread: 2553681277
---

Поделюсь некоторыми сложностями, с\ которыми я\ столкнулся, запуская [планировщик маршрута][route-planner].

Конечно, во\ время самой разработки все сложности сводились к\ алгоритмическим. В\ [Dartium] всё работало как положено
с\ нужным количеством ошибок и\ предупреждений. Проблемы начались сразу после компиляции в\ JavaScript и\ запуске
в\ обычном браузере (кто бы сомневался). Проект не\ запустился, выдав странного вида stack trace. Ну\ что\ же,
пересобираем проект без минификации. Stack trace стал читаемым, ошибки понятными. Как оказалось, вся проблема была
в\ аннотации `@MirrorsUsed`. Дело в\ том, что [mirrors] (так называется [reflection] в\ [Dart]) занимает непозволительно
много места в\ скомпилированном коде. И\ для того, чтобы этого избежать, авторы Dart предлагают использовать эту
аннотацию для указания библиотек и\ классов, информацию о\ которых нужно будет получить во\ время исполнения (кстати,
в\ будущем обещают доработать компилятор, что избавит от\ необходимости использовать эту аннотацию). Так вот, мой класс
контроллера не\ был указан в\ `@MirrorsUsed` и, соответственно, [AngularDart] не\ мог с\ ним работать.

Исправил, скомпилировал, не\ запустилось. Правда, в\ этот раз я\ увидел несколько больше, чем просто пустую страницу.
Немного поисков\ --- и\ обнаружилась вторая проблема: нельзя в\ шаблонах AngularDart использовать методы встроенных
объектов Dart. То\ есть в\ Dart можно, а\ в\ JavaScript нельзя. Конкретно в\ моем случае было написано:

~~~~~no-highlight
{{segment[0].distanceTo(segment[1]).round()}}
~~~~~

Понятное дело, JavaScript и\ не\ догадывается о\ методе `round` у\ типа `double`. Да, собственно, про существование
`double` он\ тоже не\ догадывается. Поэтому нужно писать геттер или вспомогательную функцию. Например так:

~~~~~no-highlight
{{segment[0].distanceToRound(segment[1])}}
~~~~~

Ура, запустилось! Теперь осталось собрать минифицированную версию и\ выложить. Но\ после сборки проект снова упал
с\ непонятным stack trace, как и\ в\ самом  начале.

Не\ один час был потрачен на\ гугление всевозможных причин. Дело почти дошло до\ того, чтобы написать новый багрепорт
о\ неправильной компиляции. Но\ я\ вовремя остановился, и\ хорошо, потому что ошибка была у\ меня и, кстати, довольна
простая: я\ пытался проинициализировать Яндекс.Карты, а\ функция-конструктор не\ существовала. Вот проблемная
строка, она соответствует `map = new ymaps.Map(“map”, options);` в\ JavaScript:

~~~~~dart
map = new JsObject(context['ymaps']['Map'], ["map",  options]);
~~~~~

Но\ ведь несжатая версия работает! Моё предположение, что сжатая версия приложения инициализируется значительно быстрее
и\ поэтому API Яндекс.Карт ещё не\ готово к\ тому времени, оказалось верным, и\ вызов функции `ymaps.ready` всё
исправил.

Итог. Более-менее сложное Dart-приложение хорошо работает в\ браузерах без поддержки Dart. Но\ зато когда
сталкиваешься с\ проблемой, которая возникает только в\ скомпилированном и\ минифицированном коде, можно потратить
довольно много времени на\ поиск решения просто потому, что подсказок никто не\ даст, а\ код выглядит довольно
запутанно. Но\ в\ своей практике я\ сталкивался со\ случаями, когда и\ обычное JavaScript-приложение после сжатия
начинало вести себя неправильно и\ возникали те\ же проблемы поиска решения.

Хочется отметить минификатор JS, встроенный в\ Dart. Он\ заменяет все `;` на\ переводы строк. Из-за этого
в\ результате получается файл со\ множеством строк, а\ не\ с\ одной, как в\ случае с\ другими минификаторами. А\ это,
в\ свою очередь, сильно упрощает ручной анализ кода.

[AngularDart]: https://angulardart.org/
[Dart]: https://www.dartlang.org/
[Dartium]: https://www.dartlang.org/tools/dartium/
[mirrors]: https://www.dartlang.org/articles/reflection-with-mirrors/
[reflection]: http://en.wikipedia.org/wiki/Reflection_(computer_programming)
[route-planner]: /route-planner/
